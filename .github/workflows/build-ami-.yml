name: Packer CI Merged
on:
  push:
    branches:
      - main
jobs:
  build:
    name: Build AMI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 14

      - name: Install dependencies
        run: |
          npm install
          npm install winston
<<<<<<< HEAD
=======
          
>>>>>>> 4ad0ab9 (statsd updates 21)


      - name: Display .env file
        run: |
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_NAME=swaradb" >> .env
          echo "PORT=8080" >> .env
          cat .env

      - name: Configure MySQL
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          sudo systemctl start mysql
          sudo systemctl status mysql
          mysql -u ${{ secrets.DB_USER }} -p"${{ secrets.DB_PASSWORD }}" -e "CREATE DATABASE swaradb;"

      - name: Run Integration Tests
        run: npm test
 
      - name: Download webapp repository
        run: zip -r webapp.zip ./

      - name: Configure AWS Credentials
        run: |
              aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws configure set default.region us-east-1  # Replace with your desired AWS region
              aws configure set default.output json
              aws configure set profile.aws_cli_dev.aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws configure set profile.aws_cli_dev.aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Build AMI with Packer
        run: |
          packer init .
          packer fmt -check ami-packer.pkr.hcl
          packer build ami-packer.pkr.hcl
 
      - name: Capture AMI ID from Packer Output
        id: capture-ami-id
        run: |
          ami_id=$(cat packer-build-output.txt | grep 'artifact,0,id' | cut -d' ' -f2)
          echo "AMI_ID=${ami_id}" >> $GITHUB_ENV
        working-directory: .

        continue-on-error: true  # Ignore errors if the AMI ID is not found
